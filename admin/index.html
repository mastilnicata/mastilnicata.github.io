<head>
    <link href="https://unpkg.com/netlify-cms/dist/cms.css" rel="stylesheet"/>
</head>
<body>
  <script src="/admin/scripts/config.js"></script>
  <script src="https://unpkg.com/netlify-cms/dist/netlify-cms.js"></script>
  <!-- https://github.com/uzairfarooq/arrive -->
  <script src="/admin/scripts/arrive.js"></script>
  <script>
    CMS.registerPreviewStyle("styles/custom-preview.css");
    CMS.registerPreviewStyle("../assets/css/mastilnitsata.css");
    window.CMS_MANUAL_INIT = true

    var env = "production";
    if(!configurations[env])
    {
      env = "production";
    }
    initCMS(configurations[env]);

      var TestimonialPreview = createClass({
        render: function() {
          var entry = this.props.entry;
          var name = entry.getIn(['data', 'name']);
          name = (typeof(name) == typeof(undefined))? '' : name;
          var title = entry.getIn(['data', 'title']);
          title = (typeof(title) == typeof(undefined))? '' : title;
          var tagline = entry.getIn(['data', 'tagline']);
          tagline = (typeof(tagline) == typeof(undefined))? '' : '"' + tagline + '"';
          var content = this.props.widgetFor('body');
          var genger = entry.getIn(['data', 'genger']).toLowerCase();
          var isHiddenText = 'This testimonial is ' + ((entry.getIn(['data', 'hidden']))? 'hidden':'visible!');
          var messageClass = ((entry.getIn(['data', 'hidden']))? 'hiddenPost':'visiblePost');
          var photo = entry.getIn(['data', 'photo']);
          var photosrc = this.props.getAsset(photo).toString();
          if(!photo)
          {
            photosrc = (genger=='female')? '/assets/images/icon-woman.png':'/assets/images/icon-man.png';
          }

          var nameandtitle = name;
          nameandtitle += ((nameandtitle && title)? ", " : "") + title;

          var preview = 
            h('div', {},
              h('div', {'className': 'mt-3 ' + messageClass }, isHiddenText),
              h('div', { 'className': 'bg-dark-grey p-4 mx-auto mt-3 mb-3' }, 
                h('h1', { 'className': 'text-center'}, 'Testimonial Preview'),
                h('div', { 'className':  'carousel carousel-testimonial slide', 'id' :'carouselTestimonial' },
                  h('ol', { 'className': 'carousel-indicators'},
                    h('li', {'className': 'active', 'data-target':'#carouselTestimonial', 'data-slide-to': '0' })
                  ),
                  h('div', {'className': 'carousel-inner'},
                    h('div', {'className': 'carousel-item text-center active'},
                      h('div', {'className':'carousel-testimonial-img p-1 rounded-circle m-auto'},
                        h('img', {"className": "rounded-circle", "src": photosrc, 'alt': nameandtitle })
                      ),
                      h('h5', {'className':'mt-4 mb-0'},
                        h('strong', {'className':'text-warning'}, tagline)
                      ),
                      h('h6', {'className':'m-0'}, nameandtitle),
                      h('p', {'className':'testimonial-text m-0 pt-3'}, content)
                    )
                  )
                )
              )
          );
          return preview;
        }
      });
      CMS.registerPreviewTemplate("testimonial", TestimonialPreview);


      var ContentBlockPreview = createClass({
        render: function() {
          var entry = this.props.entry;
          var content = this.props.widgetFor('body');

          var bgColor = entry.getIn(['data', 'bg-color']);
          bgColor = (typeof(bgColor) == typeof(undefined))? 'transparent' : bgColor;
          var color = entry.getIn(['data', 'color']);
          color = (typeof(color) == typeof(undefined))? 'black' : color;
          var css = entry.getIn(['data', 'css-class']);
          css = (typeof(css) == typeof(undefined))? '' : css;

          var isHiddenText = 'This content block is ' + ((entry.getIn(['data', 'hidden']))? 'hidden':'visible!');
          var messageClass = ((entry.getIn(['data', 'hidden']))? 'hiddenPost':'visiblePost');

          
          if(content)
          {
            content.props.value = content.props.value.replace(/[\\]*\[\[mastilnicata\-logo\]\]/g, '<span class="mastilnitsata mastilnitsata-mastilnitsa-handmade"></span>');
            content.props.value = content.props.value.replace(/[\\]*\[\[mastilnicata\-m\]\]/g, '<span class="mastilnitsata mastilnitsata-mastilnitsa-handmade-M"></span>');
            content.props.value = content.props.value.replace(/[\\]*\[\[mastilnicata\-feather\]\]/g, '<span class="mastilnitsata mastilnitsata-new-design-feather"></span>');
          }
           
          var preview = h('div', {},
            h('div', {'className': 'mt-3 ' + messageClass }, isHiddenText),
            h('div', { "style" : { "backgroundColor" : bgColor, "color": color  }, "className": "darksection " + css }, content)
          );
          return preview;
        }
      });
      CMS.registerPreviewTemplate("content-blocks", ContentBlockPreview);


      var AnimatedBannerPreview = createClass({
        render: function() {
          /*
          var entry = this.props.entry;
          var content = this.props.widgetFor('body');

          var bgColor = entry.getIn(['data', 'bg-color']);
          bgColor = (typeof(bgColor) == typeof(undefined))? 'transparent' : bgColor;
          var color = entry.getIn(['data', 'color']);
          color = (typeof(color) == typeof(undefined))? 'black' : color;
          var css = entry.getIn(['data', 'css-class']);
          css = (typeof(css) == typeof(undefined))? '' : css;

          var isHiddenText = 'This content block is ' + ((entry.getIn(['data', 'hidden']))? 'hidden':'visible!');
          var messageClass = ((entry.getIn(['data', 'hidden']))? 'hiddenPost':'visiblePost');

          
          if(content)
          {
            content.props.value = content.props.value.replace(/[\\]*\[\[mastilnicata\-logo\]\]/g, '<span class="mastilnitsata mastilnitsata-mastilnitsa-handmade"></span>');
            content.props.value = content.props.value.replace(/[\\]*\[\[mastilnicata\-m\]\]/g, '<span class="mastilnitsata mastilnitsata-mastilnitsa-handmade-M"></span>');
            content.props.value = content.props.value.replace(/[\\]*\[\[mastilnicata\-feather\]\]/g, '<span class="mastilnitsata mastilnitsata-new-design-feather"></span>');
          }*/
          return h('div', {}, "banner");
        }
      });
      CMS.registerPreviewTemplate("animated-banners", AnimatedBannerPreview);



      var colorpickerControl = createClass({
        handleChange: function(e) {
          this.props.onChange(e.target.value);
        },
        render: function() {
          var value = this.props.value;
          var ctl = h('div', {}, 
            h('input', { type: 'color', value: value ? value : '', onChange: this.handleChange }), 
            h('input', { type:'text', value: value ? value : '', onChange: this.handleChange })
          );
          return ctl;
        }
      });
      var colorpickerPreview = createClass({
        render: function() {
          return h('div', { "style" : { "backgroundColor" : this.props.value } } );
        }
      });
      CMS.registerWidget('color-picker', colorpickerControl, colorpickerPreview);



      String.prototype.allReplace = function(obj) {
        var retStr = this;
        for (var x in obj) {
            retStr = retStr.replace(new RegExp(x, 'g'), obj[x]);
        }
        return retStr;
      };

      var PermalinkControl = createClass({
        handleChange: function(e) {
          var sanitizedValue = e.target.value;
          sanitizedValue = sanitizedValue.toLowerCase().trim().replace(/\s/g,'-');
          sanitizedValue = sanitizedValue.allReplace(
            { 'а':'a', 'б':'b', 'в':'w', 'г':'g', 'д':'d', 'е':'e', 'ж':'zh', 
            'з':'z', 'и':'i', 'й':'j', 'к':'k', 'л':'l', 'м':'m', 'н':'n', 
            'о':'o', 'п':'p', 'р':'r', 'с':'s', 'т':'t', 'у':'u', 'ф':'f', 'х':'h', 
            'ц':'c', 'ч':'ch', 'ш':'sh', 'щ':'sht', 'ъ':'y', 'ь':'y', 'ю':'yu', 'я':'ya',
            '\\.': '-', '\\/': '-', '\\?': '-', '\\!': '-', '\\#': '-', '\\%': '-', '\\(':'-', '\\)': '-', '\\[':'-', '\\]':'-', 
            '\\{':'-', '\\\'':'-', '\\"':'-'});

          this.props.onChange(sanitizedValue);
        },
      
        render: function() {
          var value = this.props.value;
          var mirrorfield = this.props.field.get("mirrorfield");
          var additionalClass = (mirrorfield)? 'waitforit': '';

          var ctl = h('div', { style:{'backgroundColor' : 'Blue' } }, 
            h('input', { id:'permalinkvtl', className: additionalClass, type: 'text', style:{ 'backgroundColor' : 'Yellow' }, value: value, 'data-mirror': mirrorfield, onChange: this.handleChange })
            );
            var pagetitlectl = document.getElementById("pagetitlectl");

            console.log(":: :: PermalinkControl RENDER (pagetitlectl: "+pagetitlectl+")");
            if(pagetitlectl)
            {
              pagetitlectl.oninput = function() { /*document.getElementById("permalinkvtl").value = document.getElementById("pagetitlectl").value; */this.props.onChange(document.getElementById("pagetitlectl").value); }
            }

            
          return ctl;
        }
      });
      
      var PermalinkPreview = createClass({
        render: function() {
          return h('ul', {}, h('div', { style: { 'backgroundColor': 'cyan'}}, this.props.value ));
        }
      });
      CMS.registerWidget('permalink', PermalinkControl, PermalinkPreview);




      var PagetitleControl = createClass({
        handleChange: function(e) {
          this.props.onChange(e.target.value);
        },
      
        render: function() {
          var value = this.props.value;

          var idfield = this.props.field.get("id");
          var mirrored = this.props.field.get("mirrored");
          var additionalClass = (mirrored)? 'waitforit': '';

          var fieldobject = { type: 'text', className: additionalClass,  style:{'backgroundColor' : 'orange'}, value, onChange: this.handleChange };
          if(idfield)
          {
            fieldobject.id = idfield;
          }

          var ctl = h('div', { style:{'backgroundColor' : 'red' } }, 
            h('input', fieldobject)
            );
            var permalinkvtl = document.getElementById("permalinkvtl");
            console.log(":: :: PagetitleControl RENDER (permalinkvtl: "+permalinkvtl+")");
            window.waitforit = "#pagetitlectl";
          return ctl;
        }
      });
      
      var PagetitlePreview = createClass({
        render: function() {
          return h('ul', {}, h('div', { style: { 'backgroundColor': 'green'}}, this.props.value ));
        }
      });
      CMS.registerWidget('pagetitle', PagetitleControl, PagetitlePreview);

      //Wait for all the elements marked as "waitforit"
      document.arrive(".waitforit", function() {
        [].slice.call(document.getElementsByClassName("waitforit")).forEach(function(element, index){
          //is there an element mirroring another?
          var mirroredId = element.getAttribute("data-mirror");
          if(mirroredId)
          {
            //get the mirrored element
            var mirroredElement = document.getElementById(mirroredId);
            if(mirroredElement)
            {
              //mirror the value
              mirroredElement.addEventListener("input", function(){
                var val = mirroredElement.value;

                //dispatch the changed event
                var nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, "value").set;
                nativeInputValueSetter.call(element, val);
                var ev2 = new Event('input', { bubbles: true});
                element.dispatchEvent(ev2);
              });
            }
          }
        });
      });
    </script>
</body>